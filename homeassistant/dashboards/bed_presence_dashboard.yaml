# Bed Presence Dashboard
# Provides operator view and calibration wizard interface

title: Bed Presence Detector
views:
  - title: Status
    path: status
    icon: mdi:bed
    cards:
      # Current Status Card
      - type: entities
        title: Current Status
        entities:
          - entity: binary_sensor.bed_presence_detector_bed_occupied
            name: Bed Occupied
          - entity: sensor.bed_presence_detector_presence_state_reason
            name: Last State Change Reason
          - entity: sensor.bed_presence_detector_presence_change_reason
            name: Change Reason Code
          - entity: sensor.bed_presence_detector_ld2410_still_energy
            name: Current Energy Level

      # Live Energy Chart
      - type: history-graph
        title: Energy Levels (Live)
        hours_to_show: 1
        refresh_interval: 0
        entities:
          - entity: sensor.bed_presence_detector_ld2410_still_energy
            name: Still Energy
          - entity: sensor.bed_presence_detector_ld2410_moving_energy
            name: Moving Energy

      # Threshold Visualization
      - type: custom:apexcharts-card
        header:
          title: Thresholds & Current State
          show: true
        graph_span: 5min
        series:
          - entity: sensor.bed_presence_detector_ld2410_still_energy
            name: Still Energy
            stroke_width: 2
          - entity: number.bed_presence_detector_k_on_on_threshold_multiplier
            name: k_on (ON Threshold)
            type: line
            stroke_width: 1
            curve: stepline
          - entity: number.bed_presence_detector_k_off_off_threshold_multiplier
            name: k_off (OFF Threshold)
            type: line
            stroke_width: 1
            curve: stepline

  - title: Configuration
    path: config
    icon: mdi:cog
    cards:
      # Threshold Configuration
      - type: entities
        title: Threshold Settings
        entities:
          - entity: number.bed_presence_detector_k_on_on_threshold_multiplier
            name: k_on (ON Threshold Multiplier)
          - entity: number.bed_presence_detector_k_off_off_threshold_multiplier
            name: k_off (OFF Threshold Multiplier)

      # Phase 2: Debounce Timer Configuration
      - type: entities
        title: Debounce Timers
        entities:
          - entity: number.bed_presence_detector_on_debounce_ms
            name: On Debounce (ms)
          - entity: number.bed_presence_detector_off_debounce_ms
            name: Off Debounce (ms)
          - entity: number.bed_presence_detector_absolute_clear_delay_ms
            name: Absolute Clear Delay (ms)

      - type: entities
        title: Distance Window
        entities:
          - entity: number.bed_presence_detector_distance_min_cm
            name: Distance Min (cm)
          - entity: number.bed_presence_detector_distance_max_cm
            name: Distance Max (cm)

      # Quick Actions
      - type: button
        name: Reset to Factory Defaults
        tap_action:
          action: call-service
          service: esphome.bed_presence_detector_calibrate_reset_all

      - type: grid
        title: Calibration Actions
        columns: 2
        cards:
          - type: button
            name: Start Baseline (60s)
            icon: mdi:chart-bell-curve-cumulative
            tap_action:
              action: call-service
              service: esphome.bed_presence_detector_calibrate_start_baseline
              data:
                duration_s: 60
          - type: button
            name: Stop Calibration
            icon: mdi:stop
            tap_action:
              action: call-service
              service: esphome.bed_presence_detector_calibrate_stop

  # NOTE: Calibration Wizard view commented out - requires helper entities not yet defined
  # Uncomment when input_select.calibration_step, input_number.calibration_vacant_max,
  # input_number.calibration_occupied_min, input_boolean.calibration_in_progress,
  # script.calibrate_vacant_mode, and script.calibrate_occupied_mode are created
  #
  # - title: Calibration Wizard
  #   path: calibration
  #   icon: mdi:wizard-hat
  #   cards:
  #     - type: markdown
  #       content: |
  #         ## Calibration Wizard
  #
  #         Follow these steps to calibrate your bed presence detector:
  #
  #         1. **Vacant Calibration**: Ensure the bed is completely empty
  #         2. **Occupied Calibration**: Lie down on the bed in your normal sleeping position
  #         3. **Review & Apply**: Check the calculated thresholds and apply them
  #
  #     # Calibration Step Tracker
  #     - type: entities
  #       title: Calibration Progress
  #       entities:
  #         - input_select.calibration_step
  #         - input_number.calibration_vacant_max
  #         - input_number.calibration_occupied_min
  #         - input_boolean.calibration_in_progress
  #
  #     # Calibration Actions
  #     - type: horizontal-stack
  #       cards:
  #         - type: button
  #           name: Start Vacant Calibration
  #           icon: mdi:bed-empty
  #           tap_action:
  #             action: call-service
  #             service: script.calibrate_vacant_mode
  #         - type: button
  #           name: Start Occupied Calibration
  #           icon: mdi:bed
  #           tap_action:
  #             action: call-service
  #             service: script.calibrate_occupied_mode

  - title: Diagnostics
    path: diagnostics
    icon: mdi:information
    cards:
      - type: entities
        title: Device Information
        entities:
          - entity: sensor.bed_presence_detector_wifi_signal
            name: Wi-Fi Signal
          - entity: sensor.bed_presence_detector_uptime
            name: Uptime
          - entity: sensor.bed_presence_detector_ip_address
            name: IP Address
          - entity: sensor.bed_presence_detector_esphome_version
            name: ESPHome Version

      # Raw LD2410 Data
      - type: entities
        title: LD2410 Raw Data
        entities:
          - entity: binary_sensor.bed_presence_detector_ld2410_presence
            name: Raw Presence
          - entity: binary_sensor.bed_presence_detector_ld2410_moving_target
            name: Moving Target
          - entity: binary_sensor.bed_presence_detector_ld2410_still_target
            name: Still Target
          - entity: sensor.bed_presence_detector_ld2410_detection_distance
            name: Detection Distance
