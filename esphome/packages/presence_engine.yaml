# Bed Presence Engine Package - Phase 3
# Z-score presence detection with state machine, distance windowing, and calibration services

binary_sensor:
  - platform: bed_presence_engine
    name: "Bed Occupied"
    id: bed_occupied
    energy_sensor: ld2410_still_energy  # Using still/static energy per LD2410 naming
    distance_sensor: ld2410_still_distance
    distance_min_cm: 0.0
    distance_max_cm: 600.0
    k_on: 9.0   # Turn ON when z-score > 9.0 (9 std deviations)
    k_off: 4.0  # Turn OFF when z-score < 4.0 (4 std deviations)
    on_debounce_ms: 3000       # 3 seconds - sustained high signal required
    off_debounce_ms: 5000      # 5 seconds - sustained low signal required
    abs_clear_delay_ms: 30000  # 30 seconds - minimum time since last high confidence signal
    state_reason:
      name: "Presence State Reason"
      id: presence_state_reason
    last_change_reason:
      name: "Presence Change Reason"
      id: presence_change_reason

# Number inputs to allow threshold multiplier and debounce timer tuning from Home Assistant
# Phase 2+: Debounce timer controls + Phase 3 distance windowing
# Persistent across reboots (restore_value: true)
number:
  - platform: template
    name: "k_on (ON Threshold Multiplier)"
    id: k_on_input
    min_value: 0.0
    max_value: 15.0
    step: 0.1
    initial_value: 9.0
    optimistic: true
    restore_value: true  # Phase 1 requirement
    mode: slider
    on_value:
      then:
        - lambda: |-
            auto engine = id(bed_occupied);
            engine->update_k_on(x);

  - platform: template
    name: "k_off (OFF Threshold Multiplier)"
    id: k_off_input
    min_value: 0.0
    max_value: 15.0
    step: 0.1
    initial_value: 4.0
    optimistic: true
    restore_value: true  # Phase 1 requirement
    mode: slider
    on_value:
      then:
        - lambda: |-
            auto engine = id(bed_occupied);
            engine->update_k_off(x);

  # Phase 2: Debounce timer controls
  - platform: template
    name: "On Debounce Timer (ms)"
    id: on_debounce_input
    min_value: 0
    max_value: 60000
    step: 100
    initial_value: 3000
    optimistic: true
    restore_value: true
    mode: box
    unit_of_measurement: "ms"
    on_value:
      then:
        - lambda: |-
            auto engine = id(bed_occupied);
            engine->update_on_debounce_ms((unsigned long)x);

  - platform: template
    name: "Off Debounce Timer (ms)"
    id: off_debounce_input
    min_value: 0
    max_value: 60000
    step: 100
    initial_value: 5000
    optimistic: true
    restore_value: true
    mode: box
    unit_of_measurement: "ms"
    on_value:
      then:
        - lambda: |-
            auto engine = id(bed_occupied);
            engine->update_off_debounce_ms((unsigned long)x);

  - platform: template
    name: "Absolute Clear Delay (ms)"
    id: abs_clear_delay_input
    min_value: 0
    max_value: 300000
    step: 1000
    initial_value: 30000
    optimistic: true
    restore_value: true
    mode: box
    unit_of_measurement: "ms"
    on_value:
      then:
        - lambda: |-
            auto engine = id(bed_occupied);
            engine->update_abs_clear_delay_ms((unsigned long)x);

  # Phase 3: Distance window controls (cm)
  - platform: template
    name: "Distance Min (cm)"
    id: distance_min_input
    min_value: 0
    max_value: 600
    step: 5
    initial_value: 0
    optimistic: true
    restore_value: true
    mode: slider
    unit_of_measurement: "cm"
    on_value:
      then:
        - lambda: |-
            auto engine = id(bed_occupied);
            engine->update_d_min_cm(x);

  - platform: template
    name: "Distance Max (cm)"
    id: distance_max_input
    min_value: 50
    max_value: 600
    step: 5
    initial_value: 600
    optimistic: true
    restore_value: true
    mode: slider
    unit_of_measurement: "cm"
    on_value:
      then:
        - lambda: |-
            auto engine = id(bed_occupied);
            engine->update_d_max_cm(x);
