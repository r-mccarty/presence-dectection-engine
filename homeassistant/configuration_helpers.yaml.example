# Home Assistant Helper Configuration
# Add these helpers to your configuration.yaml to enable the calibration wizard

input_select:
  calibration_step:
    name: Calibration Step
    options:
      - "Not Started"
      - "Calibrating Vacant"
      - "Calibrating Occupied"
      - "Review Results"
      - "Completed"
    initial: "Not Started"

input_number:
  calibration_vacant_max:
    name: Calibration Vacant Max
    min: 0
    max: 100
    step: 1
    mode: box

  calibration_occupied_min:
    name: Calibration Occupied Min
    min: 0
    max: 100
    step: 1
    mode: box

input_boolean:
  calibration_in_progress:
    name: Calibration In Progress
    initial: false

# Calibration Scripts
script:
  calibrate_vacant_mode:
    alias: Calibrate Vacant Mode
    sequence:
      - service: input_boolean.turn_on
        target:
          entity_id: input_boolean.calibration_in_progress
      - service: input_select.select_option
        target:
          entity_id: input_select.calibration_step
        data:
          option: "Calibrating Vacant"
      - service: esphome.bed_presence_detector_calibrate_start_baseline
        data:
          duration_s: 60
      - delay:
          seconds: 30
      - service: esphome.bed_presence_detector_calibrate_stop
      - service: input_select.select_option
        target:
          entity_id: input_select.calibration_step
        data:
          option: "Review Results"

  calibrate_occupied_mode:
    alias: Calibrate Occupied Mode
    sequence:
      - service: input_boolean.turn_on
        target:
          entity_id: input_boolean.calibration_in_progress
      - service: input_select.select_option
        target:
          entity_id: input_select.calibration_step
        data:
          option: "Calibrating Occupied"
      - service: esphome.bed_presence_detector_calibrate_start_baseline
        data:
          duration_s: 60
      - delay:
          seconds: 30
      - service: esphome.bed_presence_detector_calibrate_stop
      - service: input_select.select_option
        target:
          entity_id: input_select.calibration_step
        data:
          option: "Review Results"

  apply_calibration:
    alias: Apply Calibration Results
    sequence:
      - service: number.set_value
        target:
          entity_id: number.occupied_threshold
        data:
          value: "{{ states('input_number.calibration_occupied_min') | int }}"
      - service: number.set_value
        target:
          entity_id: number.vacant_threshold
        data:
          value: "{{ states('input_number.calibration_vacant_max') | int }}"
      - service: input_select.select_option
        target:
          entity_id: input_select.calibration_step
        data:
          option: "Completed"
      - service: input_boolean.turn_off
        target:
          entity_id: input_boolean.calibration_in_progress
