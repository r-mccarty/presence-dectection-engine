---
# Bed Presence Dashboard
# Provides operator view and calibration wizard interface

title: Bed Presence Detector
views:
  - title: Status
    path: status
    icon: mdi:bed
    cards:
      # Current Status Card
      - type: entities
        title: Current Status
        entities:
          - entity: binary_sensor.bed_presence_detector_bed_occupied
            name: Bed Occupied
          - entity: sensor.bed_presence_detector_presence_state_reason
            name: Last State Change Reason
          - entity: sensor.bed_presence_detector_presence_change_reason
            name: Change Reason Code
          - entity: sensor.bed_presence_detector_ld2410_still_energy
            name: Current Energy Level

      # Live Energy Chart
      - type: history-graph
        title: Energy Levels (Live)
        hours_to_show: 1
        refresh_interval: 0
        entities:
          - entity: sensor.bed_presence_detector_ld2410_still_energy
            name: Still Energy
          - entity: sensor.bed_presence_detector_ld2410_moving_energy
            name: Moving Energy

      # Threshold Visualization
      - type: custom:apexcharts-card
        header:
          title: Thresholds & Current State
          show: true
        graph_span: 5min
        series:
          - entity: sensor.bed_presence_detector_ld2410_still_energy
            name: Still Energy
            stroke_width: 2
          - entity: number.bed_presence_detector_k_on_on_threshold_multiplier
            name: k_on (ON Threshold)
            type: line
            stroke_width: 1
            curve: stepline
          - entity: number.bed_presence_detector_k_off_off_threshold_multiplier
            name: k_off (OFF Threshold)
            type: line
            stroke_width: 1
            curve: stepline

  - title: Configuration
    path: config
    icon: mdi:cog
    cards:
      # Threshold Configuration
      - type: entities
        title: Threshold Settings
        entities:
          - entity: number.bed_presence_detector_k_on_on_threshold_multiplier
            name: k_on (ON Threshold Multiplier)
          - entity: number.bed_presence_detector_k_off_off_threshold_multiplier
            name: k_off (OFF Threshold Multiplier)

      # Phase 2: Debounce Timer Configuration
      - type: entities
        title: Debounce Timers
        entities:
          - entity: number.bed_presence_detector_on_debounce_ms
            name: On Debounce (ms)
          - entity: number.bed_presence_detector_off_debounce_ms
            name: Off Debounce (ms)
          - entity: number.bed_presence_detector_absolute_clear_delay_ms
            name: Absolute Clear Delay (ms)

      - type: entities
        title: Distance Window
        entities:
          - entity: number.bed_presence_detector_distance_min_cm
            name: Distance Min (cm)
          - entity: number.bed_presence_detector_distance_max_cm
            name: Distance Max (cm)

      # Quick Actions
      - type: grid
        title: Calibration Quick Actions
        columns: 3
        cards:
          - type: button
            name: Start Baseline (Wizard)
            icon: mdi:wizard-hat
            tap_action:
              action: call-service
              service: script.bed_presence_start_baseline_calibration
          - type: button
            name: Cancel Calibration
            icon: mdi:stop-circle-outline
            tap_action:
              action: call-service
              service: script.bed_presence_cancel_baseline_calibration
          - type: button
            name: Reset To Defaults
            icon: mdi:backup-restore
            tap_action:
              action: call-service
              service: script.bed_presence_reset_calibration_defaults

  - title: Calibration Wizard
    path: calibration
    icon: mdi:wizard-hat
    cards:
      - type: markdown
        content: |
          ## Guided Calibration

          1. Confirm the bed is empty and within the configured distance window.
          2. Toggle **Confirm Bed Is Empty**, then press **Start Baseline**.
          3. Remain out of bed until the sampling timer finishes.
          4. Review the status panel for `calibration:completed` before reusing the bed.

          > Tip: Adjust the sampling duration slider if your room is noisy. Longer captures improve MAD accuracy.

      - type: entities
        title: Wizard Status
        entities:
          - entity: input_select.bed_presence_calibration_step
            name: Current Step
          - entity: input_boolean.bed_presence_calibration_in_progress
            name: In Progress
          - entity: input_datetime.bed_presence_last_calibration
            name: Last Completed
          - entity: sensor.bed_presence_detector_presence_change_reason
            name: Change Reason (Device)

      - type: entities
        title: Preconditions & Duration
        entities:
          - entity: input_boolean.bed_presence_calibration_confirm_empty_bed
            name: I confirm the bed is empty
          - entity: input_number.bed_presence_calibration_duration_seconds
            name: Sample Duration (seconds)

      - type: horizontal-stack
        cards:
          - type: button
            name: Start Baseline
            icon: mdi:play-circle
            tap_action:
              action: call-service
              service: script.bed_presence_start_baseline_calibration
          - type: button
            name: Cancel
            icon: mdi:stop-circle
            tap_action:
              action: call-service
              service: script.bed_presence_cancel_baseline_calibration
          - type: button
            name: Reset Defaults
            icon: mdi:backup-restore
            tap_action:
              action: call-service
              service: script.bed_presence_reset_calibration_defaults

  - title: Diagnostics
    path: diagnostics
    icon: mdi:information
    cards:
      - type: entities
        title: Device Information
        entities:
          - entity: sensor.bed_presence_detector_wifi_signal
            name: Wi-Fi Signal
          - entity: sensor.bed_presence_detector_uptime
            name: Uptime
          - entity: sensor.bed_presence_detector_ip_address
            name: IP Address
          - entity: sensor.bed_presence_detector_esphome_version
            name: ESPHome Version

      # Raw LD2410 Data
      - type: entities
        title: LD2410 Raw Data
        entities:
          - entity: binary_sensor.bed_presence_detector_ld2410_presence
            name: Raw Presence
          - entity: binary_sensor.bed_presence_detector_ld2410_moving_target
            name: Moving Target
          - entity: binary_sensor.bed_presence_detector_ld2410_still_target
            name: Still Target
          - entity: sensor.bed_presence_detector_ld2410_detection_distance
            name: Detection Distance
